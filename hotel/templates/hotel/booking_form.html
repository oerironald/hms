<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking for {{ room.room_type.type }} at {{ room.hotel.name }}</title>
    <style>
        /* Basic styling */
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding: 20px;
        }
        h1, h2 {
            color: #007bff;
        }
        .room-item {
            background-color: #e3f2fd;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .room-item h3 {
            margin-bottom: 10px;
        }
        .room-item p {
            margin: 5px 0;
        }
        .room-item span {
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999; /* Ensure the modal is on top of other content */
            overflow: auto;
            padding: 10px;
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 600px; /* Max width for larger screens */
            max-height: 80vh; /* Max height for the modal */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            overflow-y: auto; /* Enable scrolling if content overflows */
        }
        h2 {
            font-size: 1.5em;
            text-align: center;
        }
        label {
            font-weight: bold;
            margin-top: 10px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;  /* Adjusted padding to make the button appropriately sized */
            cursor: pointer;
            margin-top: 10px;
            border-radius: 5px;
            width: auto; /* Adjusted for a more compact button size */
            font-size: 1rem; /* Set a comfortable font size */
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button + button {
            margin-top: 10px;
        }
        /* Mobile responsiveness */
        @media (max-width: 600px) {
            .modal-content {
                width: 95%; /* Use most of the screen width on small devices */
                max-width: 95%;
                padding: 15px;
            }
            h2 {
                font-size: 1.2em; /* Adjust heading size */
            }
        }
    </style>
</head>
<body>

<h1>Booking for {{ room.room_type.type }} at {{ room.hotel.name }}</h1>

<h2>Available Rooms</h2>

<div class="room-list">
    {% for room_info in rooms_with_availability %}
        <div class="room-item">
            <h3>Room Number: {{ room_info.room.room_number }}</h3>
            <p><span>Price per Night:</span> Kshs. {{ room_info.room.price }}</p>
            <p><span>Number of Visitors:</span> {{ room_info.room.room_type.room_capacity }}</p>
            <p><span>Availability:</span> {% if room_info.is_available %} Available {% else %} Occupied {% endif %}</p>
            <p><span>Span of Stay:</span> From {{ room_info.room.check_in_date }} to {{ room_info.room.check_out_date }}</p>

            {% if room_info.is_available %}
                <button onclick="showBookingDetails({{ room_info.room.id }}, {{ room_info.room.price }})">Book Now</button>
            {% else %}
                <p style="color: red;">Currently occupied</p>
            {% endif %}
        </div>
    {% endfor %}
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <h2>Booking Details</h2>
        <form id="booking-form">
            {% csrf_token %}
            <input type="hidden" id="room_id">
            <input type="hidden" id="amount">

            <!-- Check-in and Check-out Dates -->
            <label for="check_in_date">Check-in Date:</label>
            <input type="datetime-local" id="check_in_date" required>

            <label for="check_out_date">Check-out Date:</label>
            <input type="datetime-local" id="check_out_date" required>

            <!-- Number of adults and children -->
            <label for="num_adults">Number of Adults:</label>
            <input type="number" id="num_adults" value="1" min="1" required>

            <label for="num_children">Number of Children:</label>
            <input type="number" id="num_children" value="0" min="0" required>

            <label for="payment_method">Select Payment Method:</label>
            <select id="payment_method" required>
                <option value="MPESA">M-Pesa</option>
                <option value="CASH">Cash</option>
            </select>

            <!-- M-Pesa phone number input -->
            <div id="mpesa-details" style="display: none;">
                <label for="phone_number">Phone Number (for M-Pesa):</label>
                <input type="tel" id="phone_number" placeholder="Enter phone number" required>
            </div>

            <button type="button" onclick="handlePayment()">Proceed to Pay</button>
            <button type="button" onclick="closeModal()">Cancel</button>
        </form>
    </div>
</div>

<script>
    // Display booking modal
    function showBookingDetails(roomId, amount) {
        document.getElementById('room_id').value = roomId;
        document.getElementById('amount').value = amount;
        document.getElementById('bookingModal').style.display = 'block';
    }

    // Close booking modal
    function closeModal() {
        document.getElementById('bookingModal').style.display = 'none';
        resetModal();
    }

    // Reset modal contents after payment or cancellation
    function resetModal() {
        document.getElementById('check_in_date').value = '';
        document.getElementById('check_out_date').value = '';
        document.getElementById('num_adults').value = 1;
        document.getElementById('num_children').value = 0;
        document.getElementById('payment_method').value = 'MPESA';
        document.getElementById('phone_number').value = '';
        document.getElementById('mpesa-details').style.display = 'none';
    }

    // Handle payment method selection and show/hide phone number input for M-Pesa
    document.getElementById('payment_method').addEventListener('change', function() {
        const paymentMethod = this.value;
        const mpesaDetails = document.getElementById('mpesa-details');
        if (paymentMethod === 'MPESA') {
            mpesaDetails.style.display = 'block'; // Show phone number input
        } else {
            mpesaDetails.style.display = 'none';  // Hide phone number input
        }
    });

    // Handle the booking process and payment method selection
    // Handle the booking process and payment method selection
async function handlePayment() {
    const roomId = document.getElementById('room_id').value;
    const amount = document.getElementById('amount').value;
    const checkInDate = document.getElementById('check_in_date').value;
    const checkOutDate = document.getElementById('check_out_date').value;
    const numAdults = document.getElementById('num_adults').value;
    const numChildren = document.getElementById('num_children').value;
    const paymentMethod = document.getElementById('payment_method').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let phoneNumber = null;

    // Validate required fields
    if (!checkInDate || !checkOutDate || !numAdults || !paymentMethod) {
        alert("Please fill out all required fields.");
        return;
    }

    if (paymentMethod === 'MPESA') {
        phoneNumber = document.getElementById('phone_number').value;
        if (!phoneNumber) {
            alert("Please provide a valid phone number for M-Pesa.");
            return;
        }
    }

    try {
        const response = await fetch(`/hotel/mpesa_payment/${roomId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                phone_number: phoneNumber,  // Only send this if M-Pesa is selected
                amount: amount,
                check_in_date: checkInDate,
                check_out_date: checkOutDate,
                num_adults: numAdults,
                num_children: numChildren,
                payment_method: paymentMethod
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        if (data.ResponseCode === "0") {
            alert(data.message || "Payment initiated.");
            closeModal();
        } else {
            alert(data.error || "Failed to initiate payment.");
        }
    } catch (error) {
        console.error("Fetch Error:", error);
        alert("An error occurred. Please try again.");
    }
}

</script>

</body>
</html>
